#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è README —Ñ–∞–π–ª—ñ–≤ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–æ—Å–∏–ª–∞–Ω—å
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./tools/scripts/update_readme.sh

set -e

echo "üîç –û–Ω–æ–≤–ª–µ–Ω–Ω—è README —Ñ–∞–π–ª—ñ–≤ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Å–∏–ª–∞–Ω—å..."

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
check_dependencies() {
    log "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    
    if ! command -v find &> /dev/null; then
        error "find –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
        exit 1
    fi
    
    if ! command -v grep &> /dev/null; then
        error "grep –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
        exit 1
    fi
    
    log "–í—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –∑–Ω–∞–π–¥–µ–Ω–æ ‚úÖ"
}

# –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö README —Ñ–∞–π–ª—ñ–≤
find_readme_files() {
    log "–ü–æ—à—É–∫ README —Ñ–∞–π–ª—ñ–≤..."
    
    readme_files=$(find . -name "README.md" -type f -not -path "./app/frontend/node_modules/*" -not -path "./.venv/*" -not -path "./venv/*")
    count=$(echo "$readme_files" | wc -l)
    
    log "–ó–Ω–∞–π–¥–µ–Ω–æ $count README —Ñ–∞–π–ª—ñ–≤:"
    echo "$readme_files" | while read -r file; do
        echo "  - $file"
    done
    
    echo "$readme_files"
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Å–∏–ª–∞–Ω—å –≤ —Ñ–∞–π–ª—ñ
check_links() {
    local file="$1"
    log "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Å–∏–ª–∞–Ω—å –≤ $file"
    
    # –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ—Å–∏–ª–∞–Ω—å —Ñ–æ—Ä–º–∞—Ç—É [—Ç–µ–∫—Å—Ç](—à–ª—è—Ö)
    links=$(grep -o '\[[^]]*\]([^)]*)' "$file" 2>/dev/null | sed 's/\[[^]]*\]//g' | sed 's/^(\|)$//g' || true)
    
    if [ -n "$links" ]; then
        echo "$links" | while read -r link; do
            if [[ "$link" == http* ]]; then
                # –ó–æ–≤–Ω—ñ—à–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
                continue
            elif [[ "$link" == \#* ]]; then
                # –Ø–∫—ñ—Ä–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
                continue
            else
                # –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                if [ ! -f "$link" ] && [ ! -d "$link" ]; then
                    warn "–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: $link –≤ —Ñ–∞–π–ª—ñ $file"
                fi
            fi
        done
    fi
}

# –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç–∏ –≤ README —Ñ–∞–π–ª–∞—Ö
update_dates() {
    local file="$1"
    local current_date=$(date +"%Y-%m-%d")
    
    # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    if grep -q "–î–∞—Ç–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:" "$file"; then
        sed -i.bak "s/–î–∞—Ç–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:.*/–î–∞—Ç–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: $current_date/" "$file"
        log "–û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞—Ç—É –≤ $file"
    fi
    
    # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫—É
    if grep -q "–î–ê–¢–ê:" "$file"; then
        sed -i.bak "s/–î–ê–¢–ê:.*/–î–ê–¢–ê: $current_date/" "$file"
        log "–û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞—Ç—É –≤ –∑–∞–≥–æ–ª–æ–≤–∫—É $file"
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è
main() {
    log "–ü–æ—á–∞—Ç–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è README —Ñ–∞–π–ª—ñ–≤..."
    
    check_dependencies
    
    # –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö README —Ñ–∞–π–ª—ñ–≤
    readme_files=$(find_readme_files)
    
    # –û–±—Ä–æ–±–∫–∞ –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É
    echo "$readme_files" | while read -r file; do
        if [ -n "$file" ]; then
            log "–û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É: $file"
            
            # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Å–∏–ª–∞–Ω—å
            check_links "$file"
            
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç
            update_dates "$file"
            
            # –í–∏–¥–∞–ª–µ–Ω–Ω—è backup —Ñ–∞–π–ª—ñ–≤
            if [ -f "${file}.bak" ]; then
                rm "${file}.bak"
            fi
        fi
    done
    
    log "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ"
    
    # –ü—ñ–¥—Å—É–º–∫–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    echo ""
    log "–ü—ñ–¥—Å—É–º–∫–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
    echo "  - –û–±—Ä–æ–±–ª–µ–Ω–æ README —Ñ–∞–π–ª—ñ–≤: $(echo "$readme_files" | wc -l)"
    echo "  - –û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞—Ç: $(echo "$readme_files" | wc -l)"
    echo ""
    log "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:"
    echo "  1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è"
    echo "  2. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–∞—Ç—É—Å–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ (‚úÖ üöß ‚ùå)"
    echo "  3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ñ—Å—Ç—å —Ç–µ—Ö–Ω—ñ—á–Ω–æ—ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó"
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó
main "$@" 